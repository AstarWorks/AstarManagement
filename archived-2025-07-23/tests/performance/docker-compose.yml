version: '3.8'

services:
  k6:
    build: .
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-local}
    volumes:
      - ./results:/performance-tests/results
    depends_on:
      - backend
    networks:
      - performance-test-network
    command: >
      run 
      --out json=/performance-tests/results/results.json
      --out csv=/performance-tests/results/results.csv
      /performance-tests/tests/baseline.js

  # Backend service for testing (if running locally)
  backend:
    image: openjdk:17-jre-slim
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=test
      - DATABASE_URL=jdbc:postgresql://postgres:5432/astermanagement_test
    depends_on:
      - postgres
    networks:
      - performance-test-network
    # Note: This would need the actual backend JAR file
    # volumes:
    #   - ../../backend/build/libs/aster-management.jar:/app.jar
    # command: ["java", "-jar", "/app.jar"]

  # Test database
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=astermanagement_test
      - POSTGRES_USER=testuser
      - POSTGRES_PASSWORD=testpassword
    ports:
      - "5433:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - performance-test-network

  # Redis for caching tests
  redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    networks:
      - performance-test-network

  # InfluxDB for storing k6 metrics (optional)
  influxdb:
    image: influxdb:2.0
    ports:
      - "8086:8086"
    environment:
      - INFLUXDB_DB=k6
      - INFLUXDB_HTTP_AUTH_ENABLED=false
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - performance-test-network

  # Grafana for visualizing metrics (optional)
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - influxdb
    networks:
      - performance-test-network

volumes:
  postgres_test_data:
  influxdb_data:
  grafana_data:

networks:
  performance-test-network:
    driver: bridge