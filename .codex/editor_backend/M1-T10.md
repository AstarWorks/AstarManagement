# M1-T10 â€“ Optimistic Locking & Conflict Detection

## Goal
Introduce optimistic locking for editor nodes/documents so concurrent updates/deletions surface clear conflicts to API clients.

## Deliverables
- Extend domain models (folders/documents/metadata/revisions as needed) to carry a version field.
- Update repositories to include `version` in the `WHERE` clause for updates and bump on success.
- Surface optimistic-lock failures as a dedicated error (HTTP 409) so the frontend can prompt the user to refresh.
- Add tests covering conflict scenarios.

## Planned Steps
1. Update domain models and DTOs to include a `version` field (probably `Long`).
2. Adjust `DocumentNodeRepository` / `DocumentMetadataRepository` (and others) to perform version-checked updates and throw when zero rows are updated.
3. Convert repository failures into a domain-level exception (e.g., `OptimisticLockException`) and map to API response via `EditorExceptionHandler`.
4. Extend controllers/mappers so responses include `version`, and requests supply the expected version.
5. Write tests exercising concurrent update/delete scenarios (unit + integration).

## Progress
- [x] Domain model updated with version field.
- [x] Repository update logic uses version check.
- [x] API/DTO updated to carry version to/from clients.
- [x] Optimistic lock exceptions mapped to HTTP 409.
- [x] Tests cover conflict detection.

## Blockers / Questions
- Metadata is now versioned and validated; revisions remain append-only (no version check needed).
- Confirm frontend handles the new `version` fields (`nodeVersion`/`metadataVersion`) once OpenAPI/types are regenerated.
