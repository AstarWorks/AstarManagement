# Milestone M1 – Service Foundation & Plaintext CRUD (Weeks 1–2)

> Objective: Stand up the new document service inside the existing Spring Modulith, establish schema/migrations, and deliver fully tested plaintext CRUD for folders/documents (encryption deferred to M2).

## 1. Scope & Deliverables
- **Service bootstrap**
  - Gradle module wiring, package namespace under `com.astarworks.astarmanagement.core.editor` (or agreed name).
  - Spring configuration class with feature toggle (`app.features.editor.enabled`).
- **Persistence layer**
  - Flyway migrations for the core tables:
    - `document_nodes` (tree structure: folder/document, adjacency & materialized path columns).
    - `document_revisions` (plaintext payload columns for now, placeholders for encryption metadata).
    - `document_metadata` (key/value + tags JSONB).
  - Repository interfaces (Spring Data JDBC) + mapper implementations.
  - Testcontainers-backed repository tests validating CRUD and tree traversal queries.
- **Domain & application services**
  - Aggregates/entities mirroring the schema (DocumentNode, DocumentRevision, DocumentMetadata).
  - `FolderService` supporting create/update/move/delete + subtree listing (materialized path updates).
  - `DocumentService` supporting create/update/list revisions (no encryption, optimistic locking via version column).
- **API layer (plaintext)**
  - `EditorFolderController` (REST) with endpoints: create, update, delete, get children, get breadcrumb path.
  - `EditorDocumentController` with endpoints: create document (initial revision), update document (new revision), fetch document + latest revision, list revisions (metainfo only).
  - Request/response DTOs following existing API response envelope (`success/data/error/timestamp`).
- **Documentation & toggle**
  - Developer README for the module covering migrations, run instructions, sample cURL.
  - Feature flag defaulted to `false` in production profile, enabled in `local` for iteration.

## 2. Task Breakdown
| Seq | Task | Owner | Notes |
|-----|------|-------|-------|
| 1 | Create Gradle submodule folders & build.gradle entries | Backend | Mirror existing Modulith conventions (module descriptor optional). |
| 2 | Define Flyway migration scripts V026+ for new tables | Backend | Include indices (e.g., `tenant_id + path`, `document_id + version`). |
| 3 | Implement domain models & repositories | Backend | Leverage `BaseJsonbRepository` patterns where relevant (metadata JSON, tags). |
| 4 | Write Testcontainers integration tests for repositories | Backend QA | Use seeded data to validate materialized path updates and revision inserts. |
| 5 | Implement services with transaction boundaries | Backend | Annotate with `@Transactional` and enforce tenant context usage. |
| 6 | Build REST controllers + DTO mappers | Backend | Ensure validation annotations (title length, slug formatting). |
| 7 | Add controller integration tests (MockMvc/WebFlux) | Backend QA | Cover success, validation failure, tenant isolation. |
| 8 | Author module README + feature toggle wiring | Backend | Document env vars, toggles, runbook for enabling feature. |
| 9 | Code review & stabilize | Team | Address findings prior to milestone sign-off. |
| 10 | Implement optimistic locking & conflict detection | Backend | Surface versioned updates/deletes with 409 responses and tests. |

## 3. Acceptance Criteria
- Running `./gradlew :backend:integrationTest` executes new repository/controller tests successfully.
- Flyway migrations apply cleanly on fresh database and when upgrading from prior version.
- CRUD endpoints usable via HTTP in `local` profile (plaintext payload round-trips).
- Tenant isolation enforced: requests without tenant context rejected; cross-tenant data inaccessible.
- README references curl examples and outlines upcoming encryption work.

## 4. Out of Scope (Deferred)
- Any encryption/decryption logic (placeholder columns only).
- Search/indexing (deliberately deferred; automated indexing would currently degrade search quality, so no tsvector population yet).
- Key rotation services, audit logging, or background workers.
- Attachment/binary support.

## 5. Dependencies & Integration Notes
- Requires Postgres migrations; coordinate with DB ops for migration review (V026+ numbering).
- Reuse existing Auth/tenant context security; ensure controllers require authenticated user & tenant header.
- Potential need to extend tenant context service to support editor routes (CORS, RBAC updates in `SecurityConfig`).

## 6. Testing & QA Strategy
- **Unit tests**: Domain invariants (materialized path calculations, slug validation).
- **Integration tests**: Repository CRUD via Testcontainers; MockMvc tests hitting full stack under `@SpringBootTest` with mock auth principal.
- **Manual**: Postman/cURL smoke in local profile; verify feature flag disables endpoints when off.

## 7. Risks & Mitigations
| Risk | Mitigation |
|------|------------|
| Migration conflicts with parallel backend work | Reserve version numbers and communicate early in stand-up meeting. |
| Materialized path bugs causing orphaned nodes | Comprehensive repository tests + defensive constraints (`CHECK parent_id != id`). |
| Tenant leakage | Use tenant filter in every repository query; add integration test that ensures isolation. |

## 8. Exit Checklist
- [ ] PR merged with migrations, services, controllers, tests.
- [ ] Feature flag documented and set appropriately per environment.
- [ ] Context file (`.codex/context.md`) updated with milestone completion notes.
- [ ] Follow-up issues created for M2 encryption kick-off.

## 9. Hand-off to M2
- Provide list of columns/fields reserved for encryption metadata.
- Document API contract changes anticipated once encryption is enabled.
- Capture lessons learned / refactor items to carry into encryption phase.

---

## 日本語訳

### マイルストーン M1 – サービス基盤と平文 CRUD（1〜2週）

> 目的: 既存の Spring Modulith に新しいドキュメントサービスを組み込み、スキーマとマイグレーションを整備し、フォルダ / ドキュメント向けの平文 CRUD をテスト済みの形で提供する（暗号化は M2 で対応）。

### 1. スコープと成果物
- **サービスのブートストラップ**
  - Gradle モジュールの配線、`com.astarworks.astarmanagement.core.editor`（もしくは合意した名前）配下のパッケージ構成。
  - 機能トグル（`app.features.editor.enabled`）付きの Spring 設定クラス。
- **永続化レイヤー**
  - 中核テーブル向け Flyway マイグレーション:
    - `document_nodes`（フォルダ / ドキュメントのツリー構造。隣接リストとマテリアライズドパス列）。
    - `document_revisions`（現時点では平文ペイロード列。暗号化メタデータ用カラムはプレースホルダ）。
    - `document_metadata`（キー/バリュー + タグ JSONB）。
  - リポジトリインターフェース（Spring Data JDBC）とマッパー実装。
  - CRUD とツリー走査クエリを検証する Testcontainers ベースのリポジトリテスト。
- **ドメイン / アプリケーションサービス**
  - スキーマに対応するアグリゲート / エンティティ（DocumentNode, DocumentRevision, DocumentMetadata）。
  - `FolderService`: 作成 / 更新 / 移動 / 削除 + サブツリー一覧（マテリアライズドパス更新）を提供。
  - `DocumentService`: 作成 / 更新 / リビジョン一覧（暗号化なし、バージョン列による楽観ロック）。
- **API レイヤー（平文）**
  - `EditorFolderController`（REST）: 作成、更新、削除、子ノード取得、パンくずリスト取得の各エンドポイント。
  - `EditorDocumentController`: ドキュメント作成（初回リビジョン）、ドキュメント更新（新規リビジョン）、ドキュメント + 最新リビジョン取得、リビジョン一覧（メタ情報のみ）。
  - 既存の API レスポンスフォーマット（`success/data/error/timestamp`）に従うリクエスト / レスポンス DTO。
- **ドキュメントとトグル**
  - モジュールの開発者向け README（マイグレーション、実行手順、サンプル cURL を記載）。
  - 本番プロファイルでは機能トグルをデフォルト無効、`local` プロファイルでは有効化。

### 2. タスク分解
| Seq | タスク | 担当 | 備考 |
|-----|--------|------|------|
| 1 | Gradle サブモジュールフォルダと build.gradle の追加 | Backend | 既存 Modulith の慣例を踏襲（モジュール記述子は任意）。 |
| 2 | 新テーブル向け Flyway マイグレーション V026+ を作成 | Backend | インデックス（例: `tenant_id + path`, `document_id + version`）を含める。 |
| 3 | ドメインモデルとリポジトリを実装 | Backend | 必要に応じて `BaseJsonbRepository` パターンを再利用（メタデータ JSON、タグなど）。 |
| 4 | Testcontainers リポジトリテストを作成 | Backend QA | マテリアライズドパスの更新とリビジョン登録を検証するシードデータを使用。 |
| 5 | トランザクション境界を持つサービスを実装 | Backend | `@Transactional` を付与し、テナントコンテキストの利用を徹底。 |
| 6 | REST コントローラと DTO マッパーを実装 | Backend | バリデーションアノテーション（タイトル長、スラッグ形式など）を適用。 |
| 7 | コントローラインテグレーションテスト（MockMvc / WebFlux）を追加 | Backend QA | 成功、バリデーションエラー、テナント分離を網羅。 |
| 8 | モジュール README と機能トグル配線を作成 | Backend | 環境変数、トグル、機能有効化手順を記載。 |
| 9 | コードレビューと安定化 | Team | マイルストーン完了前に指摘へ対応。 |

### 3. 受け入れ条件
- `./gradlew :backend:integrationTest` が新規リポジトリ / コントローラテストを含めて成功する。
- Flyway マイグレーションが新規 DB、既存バージョンからのアップグレード双方で問題なく適用される。
- `local` プロファイルで HTTP 経由の CRUD エンドポイントが平文ペイロードの往復を完了できる。
- テナント分離が維持される（テナントコンテキストなしのリクエストは拒否され、他テナントデータにはアクセスできない）。
- README に curl 例と、今後予定されている暗号化作業の概要が記載されている。

### 4. スコープ外（後続対応）
- 暗号化 / 復号処理全般（プレースホルダ列のみ）。
- 検索 / インデックス処理（現状の検索品質が下がる懸念があるため見送り。tsvector 未実装）。
- 鍵ローテーションサービス、監査ログ、バックグラウンドワーカー。
- 添付ファイル / バイナリ対応。

### 5. 依存関係と統合メモ
- Postgres マイグレーションが必要。DB 運用チームとバージョン（V026 以降）調整を実施。
- 既存の認証 / テナントコンテキストを流用し、コントローラで認証済みユーザーとテナントヘッダを必須化。
- エディタ用ルートに合わせてテナントコンテキストサービス、CORS、`SecurityConfig` の RBAC などを拡張する可能性あり。

### 6. テストと QA 戦略
- **ユニットテスト**: マテリアライズドパス計算、スラッグバリデーションなどのドメイン不変条件。
- **インテグレーションテスト**: Testcontainers を利用したリポジトリ CRUD、`@SpringBootTest` + MockMvc でモック認証つきのフルスタック検証。
- **手動テスト**: `local` プロファイルで Postman / cURL によるスモークテスト。機能トグルが無効時にエンドポイントが閉じることを確認。

### 7. リスクと対策
| リスク | 対策 |
|--------|------|
| 並行開発中のバックエンドとマイグレーションが衝突 | バージョン番号を事前に確保し、スタンドアップミーティングで早期共有。 |
| マテリアライズドパスの不具合で孤立ノードが発生 | リポジトリテストを充実させ、`CHECK parent_id != id` など防御的な制約を追加。 |
| テナント間漏洩 | 全リポジトリクエリでテナントフィルタを適用し、分離を検証するインテグレーションテストを追加。 |

### 8. 完了チェックリスト
- [ ] マイグレーション、サービス、コントローラ、テストを含む PR をマージ。
- [ ] 各環境に応じた機能トグル設定とドキュメントを整備。
- [ ] マイルストーン完了を `.codex/context.md` に記録。
- [ ] M2 の暗号化開始に向けたフォローアップ課題を作成。

### 9. M2 への引き継ぎ
- 暗号化メタデータ用に確保したカラム / フィールド一覧を共有。
- 暗号化有効化後に想定される API 契約の変更点を文書化。
- 暗号化フェーズに持ち込むべき学び / リファクタ項目を整理。
