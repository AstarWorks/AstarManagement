# Flexible Table System - 実装計画

## プロジェクト概要
Astar ManagementにNotionライクな柔軟なテーブルシステムを実装する。段階的なアプローチで、最小限の機能から始めて徐々に拡張していく。

## 実装フェーズ

### Phase 1: 最小基盤（2-3日）
**目標**: 最小限の動作するテーブルシステム + 型カタログ基盤

#### データベース（V012）
- [x] workspacesテーブル（必須フィールドのみ）
- [x] databasesテーブル（必須フィールドのみ）
- [ ] **property_type_catalogテーブル** ← ハイブリッド案
- [ ] **基本型の初期データ投入（18種類）** ← ハイブリッド案
- [x] 基本的なRLS設定
- [ ] 基本インデックス

#### バックエンドAPI
- [ ] **PropertyTypeCatalog読み取りAPI** ← ハイブリッド案
- [ ] Workspace CRUD API
- [ ] Database CRUD API（type_id参照対応）
- [ ] **型に基づくバリデーション** ← ハイブリッド案

#### フロントエンド
- [ ] ワークスペース一覧画面
- [ ] データベース作成画面（型カタログ対応版）

### Phase 2: レコード機能（3-4日）
**目標**: 実際にデータを保存・表示できる

#### データベース（V013）
- [ ] recordsテーブル
- [ ] JSONB基本インデックス
- [ ] レコードのRLS

#### バックエンドAPI
- [ ] Record CRUD API
- [ ] 基本的なフィルタリング
- [ ] ソート機能

#### フロントエンド
- [ ] テーブルビュー（基本版）
- [ ] レコード追加・編集フォーム
- [ ] 基本的なデータ表示

### Phase 3: プロパティシステム（4-5日）
**目標**: 多様なデータ型のサポート

#### データベース
- [ ] プロパティ定義の拡張
- [ ] バリデーションルール

#### バックエンドAPI
- [ ] プロパティタイプのバリデーション
- [ ] 型変換処理

#### フロントエンド
- [ ] プロパティ設定UI
- [ ] 各データ型の入力コンポーネント
  - [ ] テキスト
  - [ ] 数値
  - [ ] 日付
  - [ ] 選択（単一/複数）
  - [ ] チェックボックス

### Phase 4: ビューシステム（5-6日）
**目標**: 多様な表示方法

#### データベース（V014）
- [ ] viewsテーブル
- [ ] ビュー設定の保存

#### バックエンドAPI
- [ ] View CRUD API
- [ ] フィルター処理
- [ ] グループ化処理

#### フロントエンド
- [ ] ビュー切り替えUI
- [ ] カンバンビュー
- [ ] フィルター・ソートUI

### Phase 5: 最適化（2-3日）
**目標**: パフォーマンス改善

#### データベース（V015）
- [ ] GINインデックス追加
- [ ] 特定フィールドのインデックス
- [ ] クエリ最適化

#### バックエンド
- [ ] ページネーション最適化
- [ ] キャッシング戦略
- [ ] N+1問題の解決

### Phase 6: 高度な機能（今後）
- [ ] Formula/Rollup
- [ ] リレーション
- [ ] 権限管理の詳細化
- [ ] リアルタイム同期
- [ ] インポート/エクスポート

## 技術スタック

### バックエンド
- Spring Boot (Kotlin)
- PostgreSQL + JSONB + 型カタログ（ハイブリッド）
- Flyway (マイグレーション)
- JPA/Hibernate

### フロントエンド
- Nuxt 3 + Vue 3
- TypeScript
- Pinia (状態管理)
- TanStack Table (テーブルコンポーネント)

## ハイブリッド設計の採用理由

### 移行コスト分析
| 項目 | 後から移行 | 最初から実装 |
|------|-----------|------------|
| データ移行 | 2日 | 0日 |
| バックエンド修正 | 2日 | +0.5日 |
| フロントエンド修正 | 2日 | +0.5日 |
| テスト修正 | 1日 | 0日 |
| **合計** | **7日** | **1日追加** |

### ハイブリッド設計のメリット
1. **型の一貫性**: システム全体で統一された型定義
2. **JSONBの柔軟性**: 実データは引き続きJSONBで管理
3. **パフォーマンス**: JOINが不要でクエリが単純
4. **段階的活用**: Phase 1では参照のみ、徐々に機能拡大
5. **移行コストゼロ**: 最初から正しい設計で実装

## 成功指標

### Phase 1完了条件
- [ ] ワークスペースが作成できる
- [ ] データベース（テーブル定義）が作成できる
- [ ] マルチテナントで動作する

### Phase 2完了条件
- [ ] レコードが保存できる
- [ ] レコードが表示できる
- [ ] 基本的なCRUD操作が動作する

### Phase 3完了条件
- [ ] 5種類以上のデータ型が使える
- [ ] プロパティの追加・編集ができる
- [ ] データ型に応じた入力UIが表示される

## リスクと対策

### リスク1: JSONB性能問題
**対策**: 
- 段階的にインデックスを追加
- 頻繁にアクセスされるフィールドは別カラムに移行を検討

### リスク2: フロントエンドの複雑性
**対策**:
- コンポーネントを小さく保つ
- Storybookでコンポーネント単位でテスト
- 既存のUIライブラリを活用

### リスク3: データ移行の複雑性
**対策**:
- 各フェーズで後方互換性を保つ
- マイグレーションは追加のみ（変更・削除は避ける）
- 本番環境への適用前に十分なテスト

## 開発の進め方

### 1. ドキュメント駆動
1. `flexible-table-migration-draft.md`で設計を詰める
2. レビュー・フィードバック
3. 実装

### 2. 段階的実装
1. 最小限の機能で動作確認
2. 問題があれば修正
3. 次の機能を追加

### 3. テスト戦略
- 各フェーズでE2Eテストを作成
- APIテストを優先
- フロントエンドは主要な操作パスをテスト

## 現在のステータス

### 完了
- [x] 要件定義ドキュメント作成
- [x] データモデル設計
- [x] 作業用ドキュメント作成

### 進行中
- [ ] Phase 1: V012マイグレーション設計

### 次のステップ
1. V012マイグレーションファイルの作成
2. Workspace/Database用のKotlinエンティティ作成
3. 基本的なCRUD APIの実装

## 参考リンク
- [Notion API Documentation](https://developers.notion.com/)
- [PostgreSQL JSONB Best Practices](https://www.postgresql.org/docs/current/datatype-json.html)
- [Spring Boot + PostgreSQL JSONB](https://www.baeldung.com/spring-boot-postgresql-jsonb)

## 質問・懸念事項
1. プロパティの型定義をどこまで厳密にするか？
2. パフォーマンスのボトルネックになりそうな箇所は？
3. 既存のExpense機能との統合方法は？

## 更新履歴
- 2024-XX-XX: 初版作成
- 2024-XX-XX: Phase 1の詳細追加